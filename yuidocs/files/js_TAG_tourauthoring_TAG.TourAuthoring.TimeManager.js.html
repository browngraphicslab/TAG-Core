<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>js/TAG/tourauthoring/TAG.TourAuthoring.TimeManager.js - Touch Art Gallery web application</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../../images/WideLogo.scale-100.png" title="Touch Art Gallery web application"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/TAG.AnnotatedImage.html">TAG.AnnotatedImage</a></li>
            
                <li><a href="../classes/TAG.Authoring.EditorMenu.html">TAG.Authoring.EditorMenu</a></li>
            
                <li><a href="../classes/TAG.Layout.ArtworkEditor.html">TAG.Layout.ArtworkEditor</a></li>
            
                <li><a href="../classes/TAG.Layout.ArtworkViewer.html">TAG.Layout.ArtworkViewer</a></li>
            
                <li><a href="../classes/TAG.Layout.CollectionsPage.html">TAG.Layout.CollectionsPage</a></li>
            
                <li><a href="../classes/TAG.Layout.InternetFailurePage.js.html">TAG.Layout.InternetFailurePage.js</a></li>
            
                <li><a href="../classes/TAG.Layout.StartPage.html">TAG.Layout.StartPage</a></li>
            
                <li><a href="../classes/TAG.Layout.VideoPlayer.html">TAG.Layout.VideoPlayer</a></li>
            
                <li><a href="../classes/TAG.TourAuthoring.ArtworkTrack.html">TAG.TourAuthoring.ArtworkTrack</a></li>
            
                <li><a href="../classes/TAG.TourAuthoring.AudioTrack.html">TAG.TourAuthoring.AudioTrack</a></li>
            
                <li><a href="../classes/TAG.TourAuthoring.Command.html">TAG.TourAuthoring.Command</a></li>
            
                <li><a href="../classes/TAG.TourAuthoring.ComponentControls.html">TAG.TourAuthoring.ComponentControls</a></li>
            
                <li><a href="../classes/TAG.TourAuthoring.Display.html">TAG.TourAuthoring.Display</a></li>
            
                <li><a href="../classes/TAG.TourAuthoring.ImageTrack.html">TAG.TourAuthoring.ImageTrack</a></li>
            
                <li><a href="../classes/TAG.TourAuthoring.InkAuthoring.html">TAG.TourAuthoring.InkAuthoring</a></li>
            
                <li><a href="../classes/TAG.TourAuthoring.InkTrack.html">TAG.TourAuthoring.InkTrack</a></li>
            
                <li><a href="../classes/TAG.TourAuthoring.Keyframe.html">TAG.TourAuthoring.Keyframe</a></li>
            
                <li><a href="../classes/TAG.TourAuthoring.PlaybackControl.html">TAG.TourAuthoring.PlaybackControl</a></li>
            
                <li><a href="../classes/TAG.TourAuthoring.Timeline.html">TAG.TourAuthoring.Timeline</a></li>
            
                <li><a href="../classes/TAG.TourAuthoring.TimeManager.html">TAG.TourAuthoring.TimeManager</a></li>
            
                <li><a href="../classes/TAG.TourAuthoring.TopMenu.html">TAG.TourAuthoring.TopMenu</a></li>
            
                <li><a href="../classes/TAG.TourAuthoring.TourOptions.html">TAG.TourAuthoring.TourOptions</a></li>
            
                <li><a href="../classes/TAG.TourAuthoring.Track.html">TAG.TourAuthoring.Track</a></li>
            
                <li><a href="../classes/TAG.TourAuthoring.UndoManager.html">TAG.TourAuthoring.UndoManager</a></li>
            
                <li><a href="../classes/TAG.TourAuthoring.VideoTrack.html">TAG.TourAuthoring.VideoTrack</a></li>
            
                <li><a href="../classes/TAG.TourAuthoring.Viewer.html">TAG.TourAuthoring.Viewer</a></li>
            
                <li><a href="../classes/TAG.Util.Artwork.html">TAG.Util.Artwork</a></li>
            
                <li><a href="../classes/TAG.Util.IdleTimer.html">TAG.Util.IdleTimer</a></li>
            
                <li><a href="../classes/TAG.Util.Splitscreen.html">TAG.Util.Splitscreen</a></li>
            
                <li><a href="../classes/tagInk.html">tagInk</a></li>
            
                <li><a href="../classes/Telemetry.html">Telemetry</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: js/TAG/tourauthoring/TAG.TourAuthoring.TimeManager.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
ï»¿TAG.Util.makeNamespace(&#x27;TAG.TourAuthoring.TimeManager&#x27;);

/**Manages all time-related things in TourAuthoring
 * Stores info re: start/end, current time, scale
 * Scale converts between time space (seconds) and pixel space (pixels on timeline)
 * Dispatches events to subscribers on time changes
 * All time values stored as seconds
 * @class TAG.TourAuthoring.TimeManager
 * @constructor
 * @param spec      start, end, scale, current parameters, all integers, all in seconds (not required)
 * @param my        not used
 * @return that     object containing public functions
 */
TAG.TourAuthoring.TimeManager = function (spec, my) { //get rid of my- look to make sure never called in other files?
    &quot;use strict&quot;;

    spec = spec || {};

    // PRIVATE DOM elements
    var player = null,                                                                                 // Holds interval during playback

        // initial time settings
        start = spec.start || 0,                                                                       // initial start time
        end = spec.end || 180,                                                                         // initial end time
        scale = spec.scale || 20,                                                                      // Defines px per sec
        current = spec.current || 0,                                                                   // current time
                                                                                                       // Event handling
        seekSubscribers = [],                                                                          // array of subscribers for the seeking event
        durationSubscribers = [],                                                                      // array of subscribers for the duration updating event
        playStartSubscribers = [],                                                                     // array of subscribers for &#x27;play&#x27; event
        playSubscribers = [],                                                                          // array of subscribers for play updating events
        stopSubscribers = [],                                                                          // array of subscribers for &#x27;stop&#x27; event
        moveSubscribers = [],                                                                          // array of subscribers for &#x27;move&#x27; event
        ready = false,                                                                                 // checks state of viewer
        getViewerTime = null,                                                                          // current registered time on the viewer
        currentPx = null,                                                                              // current Pixel value of the tour

        that = {                                                                                       // public methods of the class
            setTime: setTime,
            setStart: setStart,
            setEnd: setEnd,
            setScale: setScale,
            seek: seek,
            seekByAmount: seekByAmount,
            seekToPercent: seekToPercent,
            setReady: setReady,
            getReady: getReady,
            registerTime: registerTime,
            getScale: getScale,
            play: play,
            stop: stop,
            timeToPx: timeToPx,
            pxToTime: pxToTime,
            formatTime: formatTime,
            unformatTime: unformatTime,
            getCurrentTime: getCurrentTime,
            getCurrentPx: getCurrentPx,
            getCurrentPercent: getCurrentPercent,
            getDuration: getDuration,
            onSeek: onSeek,
            onSizing: onSizing,
            onPlayStart: onPlayStart,
            onPlay: onPlay,
            onStop: onStop,
            onMove: onMove,
        };
       
    
 

    /////////////
    // SETTERS //
    /////////////

    /**Generally should use setTime once everything has been initialized:
     * All time-dependent text in DOM is updated as well to reflect changes.
     * @method setTime
     * @param {Object} newspec      contains new start, end, and scale properties
     */
    function setTime (newspec) {
        // Duration updates
        var updated = [];
        if (newspec.start) {
            currentPx = null;
            start = newspec.start; //LVK- changed these from spec.start to newspec.start, Not sure if this was ever called cause it seems like it had errors
            updated.push(&#x27;start&#x27;);
        }
        if (newspec.end) {
            end = newspec.end;
            updated.push(&#x27;end&#x27;);
        }
        if (newspec.scale) {
            currentPx = null;
            scale = newspec.scale;
            updated.push(&#x27;scale&#x27;);
        }
        if (newspec.start || newspec.end || newspec.scale) {
            _sendSizing({ start: start, end: end, scale: scale, updated: updated });
        }
        // Seek updates
        if (newspec.current) {
            currentPx = null;
            current = newspec.current;
            _sendSeek({ current: current });
        }
    }

    /**Sets start
     * @method setStart
     * @param {Time} newStart     in seconds
     */
    function setStart(newStart) {
        currentPx = null;
        start = newStart;
        _sendSizing({ start: start, end: end, scale: scale, updated: [&#x27;start&#x27;] });
    }

    /**Sets end time
     * @method setEnd
     * @param {Time} newEnd       in seconds
     */
    function setEnd (newEnd) {
        end = newEnd;
        if (current &gt; end) {
            currentPx = null;
            current = end;
        }
        _sendSizing({ start: start, end: end, scale: scale, updated: [&#x27;end&#x27;] });
    }

    /*Sets scale (pixels per second)
     * @method setScale
     * @param {Number} newScale      px/sec
     */
    function setScale(newScale) {
        currentPx = null;
        scale = newScale;
        _sendSizing({ start: start, end: end, scale: scale, updated: [&#x27;scale&#x27;] });
    }

    //////////////////////
    // SEEKING FUCTIONS //
    //////////////////////

    /**Seek to a specific time
     * @method seek
     * @param {Integer} newTime     in seconds
     */
    function seek(newTime) {
        var pct;
        if (newTime &lt; 0) {                                  //prevent seeking to -1 sec
            newTime = 0;
        } else if (newTime &gt; end) {                         // prevent seeking past the end of the timeline
            newTime = end;
        }
        currentPx = null;
        current = newTime;
        pct = ((current - start) / (end - start)); 
        _sendMove({ current: current, percent: pct });
        _sendSeek({ current: current, percent: pct });
        if (current &gt; end) {
            console.log(&#x27;On timeManager seek: asked to seek past end (normal seek)&#x27;);
        }
    }
    
    /**Seek by a certain amount past current time 
     * @method seekByAmound
     * @param {Time} amount        in seconds
     */
    function seekByAmount(amount) {
        var pct;
        currentPx = null;
        //TODO- should probably have check to make sure doesn&#x27;t pass end
        current += amount;
        pct = ((current - start) / (end - start));
        _sendMove({ current: current, percent: pct });
        _sendSeek({ current: current, percent: pct });
        if (current &gt; end) {
            console.log(&#x27;On timeManager seek: asked to seek past end (amount seek)&#x27;);
        }
    }

    /**Seek to a specific percent of the tour length
     * @method seekToPercent
     * @param {Number} per         percent (as decimal)
     */
    function seekToPercent(per) {
        currentPx = null;
        current = (end - start) * per;
        _sendMove({ current: current, percent: ((current - start) / (end - start)) });
        _sendSeek({ current: current, percent: per });
    }

    /**Set state of viewer
     * @param {Boolean} isReady       whether the tour can play
     */
    function setReady(isReady) {
        ready = isReady;
    }

    /**Get state from viewer
    * @method getReady
    * @return {Boolean} ready       whether the tour can play
    */
    function getReady() {
        return ready;
    }
    
    /**Register current time on the viewer
     * @method registerTime
     * @param {Function} func
     */
    function registerTime(func) {
        getViewerTime = func;
    }

    /**Return time scale
     * @method getScale
     * @return {Number} scale       pixels per second scale on the timeline
     */
    function getScale() {
        return scale;
    }

    /**Drives forward current time to mimic playback
     * @method play
     */
    function play () {
        var interval = 100, last = -10,//?
            useInternalTime = false, lastInternalTime = Date.now(),//?
            pct = ((current - start) / (end - start));

        _sendMove({ current: current, percent: pct });
        _sendPlayStart({ current: current, percent: pct });

        player = window.requestAnimationFrame(function updatePlay(timestamp) {      //window?
            player = window.requestAnimationFrame(updatePlay);
            // update program state
            if (ready) {
                if (!useInternalTime) {         //internal time?
                    current = getViewerTime();
                    if (current === last) {
                        useInternalTime = true;
                        current += (timestamp - lastInternalTime) / 1000;
                     }
                } else {
                    current += (timestamp - lastInternalTime) / 1000;
                }

                if (current &gt;= end) {
                    current = end;
                    stop();
                }

                _sendPlay({ current: current, percent: ((current - start) / (end - start)) });
                
                currentPx = null;
                last = current;
                lastInternalTime = timestamp;
            }
        });
    }
   
    /**Stops playback if time manager is playing
     * @method stop
     */
    function stop () {
        if (player) {
            window.cancelAnimationFrame(player);
            player = null;
            _sendStop();
        }
    }
    onSeek(stop); // Automatically stop playback when a seek occurs

    /**Convert time to pixel scale
     * @method timeToPx
     * @param {Time} t
     * @return {Number}         in pixels
     */
    function timeToPx(t) {
        return (t - start) * scale;
    }

    /**Convert pixel scale to time scale
     * @method pxToTime
     * @param {Number} px
     * @return {Time}           in seconds
     */
    function pxToTime(px) {
        return (px / scale) + start;
    }

    /**Sets the time display format
     * @method formatTime
     * @param {Time} seconds
     * @return {Time} formatted as &#x27;min:sec&#x27;
     */
    function formatTime(seconds) {
        var min = parseInt(seconds / 60, 10);
        var sec = Math.floor(seconds % 60);
        if (sec &lt; 10) {
            sec = &#x27;0&#x27; + sec;
        }
        return min + &#x27;:&#x27; + sec;
    }

    /**Change formatted time to seconds
     * @method unformatTime
     * @param {String} string           time as &#x27;min:sec&#x27;
     * @return {Time}                   in seconds
     */
    function unformatTime(string) {
        // Strings are expected in format: MM:SS  #TODO: include milliseconds?
        var min, sec;
        string.split(&#x27;:&#x27;);
        min = parseFloat(min);
        sec = parseFloat(sec);
        return min * 60 + sec;
    }

    /**Grab current time in editor using playhead position
     * @method getCurrentTime
     * @return     Current time (in time-space)
     */
    function getCurrentTime() {
        return current;
    }
    
    /**Returns current pixel position
     * @method getCurrentPx
     * @return {Number} currentPx
     */
    function getCurrentPx() {
        if (!currentPx) {
            currentPx = timeToPx(current);
        }
        return currentPx;
    }
   
    /**Grab current time as percent complete of tour
     * @method getCurrentPercent
     * @return {Number}     Current time (as percentage)
     */
    function getCurrentPercent() {
        return (current - start) / (end - start);
    }
    
    /**Gets description of current duration
     * @method getDuration
     * @return {Object}     Object w/ start, end, scale parameters
     */
    function getDuration() {
        return {
            start: start,
            end: end, 
            scale: scale
        };
    }

    // Event subscribers
    
    /**Add an event handler to be called on updating of current time (during playback or seek)
     * @method onSeek
     * @param {Event} handler   Event handler to be called whenever current time is updated
     */
    function onSeek (handler) {
        seekSubscribers.push(handler);
    }
    
    /**Dispatches events to subscribers on seek update (private)
     * Context is set as time object
     * @method _sendSeek
     * @param {Event} ev    The event: current, percent parameters
     */
    function _sendSeek (ev) {
        var i;
        for (i = 0; i &lt; seekSubscribers.length; i++) {
            seekSubscribers[i].call(that, ev);
        }
    }

    /**Add an event handler to be called on updating of duration
     * @method onSizing
     * @param {Event} handler   Event handler to be called whenever start, end, or scale is updated
     */
    function onSizing (handler) {
        durationSubscribers.push(handler);
    }
   
    /**Dispatches events to subscribers on duration update (private)
     * Context is set as time object
     * @method _sendSizing
     * @param {Object} ev    The event: start, end, scale, updated parameters
     */
    function _sendSizing (ev) {
        var i;
        for (i = 0; i &lt; durationSubscribers.length; i++) {
            durationSubscribers[i].call(that, ev);
        }
    }

    /**Add an event handler to be called on play() / when it is called
     * Will only be called once
     * @method onPlayStart
     * @param {Event} handler       Event handler
     */
    function onPlayStart(handler) {
        playStartSubscribers.push(handler);
    }
    
    /**Dispatches events to subscribers on play (private)
     * @method _sendPlayStart
     * @param {Event} ev    The event: current, percent parameters
     */
    function _sendPlayStart(ev) {
        var i;
        for (i = 0; i &lt; playStartSubscribers.length; i++) {
            playStartSubscribers[i].call(that, ev);
        }
    }

    /**Add an event handler to be called during player interval updates
     * @method onPlay
     * @param {Event} handler       Event handler
     */
    function onPlay (handler) {
        playSubscribers.push(handler);
    }
    //?when/how is handler accessed?
    //that.onPlay = onPlay;

    /**Dispatches events to subscribers on play updates (private)
     * Context is set as time object
     * @method _sendPlay
     * @param {Event} ev    The event: current, percent parameters
     */
    function _sendPlay(ev) {
        var i;
        for (i = 0; i &lt; playSubscribers.length; i++) {
            playSubscribers[i].call(that, ev);
        }
    }

    /**Add an event handler to be called on stop
     * @method onStop
     * @param {Event} handler       Event Handler to be called whenever stop() is called
     */
    function onStop(handler) {
        stopSubscribers.push(handler);
    }
   
    /**Dispatches events to subscribers on play (private)
     * Context is set as time object
     * @method _sendStop
     * @param {Event} ev    The event: no use at the moment
     */
    function _sendStop (ev) {
        var i;
        for (i = 0; i &lt; stopSubscribers.length; i++) {
            stopSubscribers[i].call(that, ev);
        }
    }

    /**Add an event handler to be called on move (either play or seek)
     * Executes before other actions in play or seek, allowing safe updates
     * @method onMove
     * @param {Event} handler       Event handler to be called whenever play() or seek() is called
     */
    function onMove(handler) {
        moveSubscribers.push(handler);
    }
    
    /**Dispatches events to subscribers on move (private)
     * Context is set as time object
     * @method _sendMove
     * @param {Event} ev    The event: current, percent parameters
     */
    function _sendMove(ev) {
        var i;
        for (i = 0; i &lt; moveSubscribers.length; i++) {
            moveSubscribers[i].call(that, ev);
        }
    }
    
    return that;
};


    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
